<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>FP Programmers</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<script src="jquery-1.9.1.min.js"></script>
		<script src="md5-min.js"></script>
		<link rel="stylesheet" type="text/css" href="main.css"/>
		
		<script>
			var storage, fail, uid;
			try {
				uid = new Date;
				(storage = window.localStorage).setItem(uid, uid);
				fail = storage.getItem(uid) != uid;
				storage.removeItem(uid);
				fail && (storage = false);
			} catch(e) {}

			var socket = null;
			
			setInterval(function () {
				if (socket != null)
					send({ Type: "ping" });
			}, 100);
			
			function connect() {
				socket = new WebSocket("ws://209.141.59.194:12000/");
				
				socket.onopen = function (event) {
					addMessage(0, "*", "Connected to RohPod.");
					
					if (storage) {
						var user = storage.getItem("user");
						var pass = storage.getItem("pass");
						if (user !== null || pass !== null) {
							login(user, pass, false);
							return;
						}
					}
					
					login("guest", "", true);
				};
				
				socket.onclose = function (event) {
					addMessage(0, "*", "Lost connection to RohPod. Retrying...");
					socket = null;
					
					setTimeout(function () {
						connect();
					}, 1000);
				};
				
				socket.onerror = function (event) {
					addMessage(0, "*", "WebSocket error: " + event.data + ". Reconnecting...");
					socket = null;
					
					setTimeout(function () {
						connect();
					}, 1000);
				};
				
				socket.onmessage = function (event) {
					var data = JSON.parse(event.data);
					
					switch (data.Type)
					{
						case "clientPermissions": {
							if (data.CanChat) {
								$("#chatInput").removeAttr("disabled");
								$("#chatInput").val("");
							} else {
								$("#chatInput").attr("disabled","disabled");
								$("#chatInput").val("Guests can not speak.");
							}
							break;
						}
						
						case "chatHistory": {
							for (var i = 0; i < data.Lines.length; i++) {
								var f = data.Lines[i];
								addMessage(f.Date, f.Sender, f.Content);
							}
							
							// make sure we scroll to the bottom
							$("#messages").scrollTop($("#messages")[0].scrollHeight);
							setTimeout(function () {
								$("#messages").scrollTop($("#messages")[0].scrollHeight);
							}, 250);
							break;
						}
						
						case "message": {
							addMessage(data.Date, data.Sender, data.Content);
							break;
						}
					}
				};
			}
			
			function send(obj) {
				try {
					socket.send(JSON.stringify(obj));
				} catch (err) { } // fuck u dlaor
			}
			
			function login(username, password, hash) {
				if (hash) password = hex_md5(password);
				send({ Type: "login", Username: username, Password: password });
			}
			
			function chat(message) {
				send({ Type: "sendMessage", Content: message });
			}
			
			function addMessage(date, sender, message) {
				var elem = $("#messages");
				var atBottom = (elem[0].scrollHeight - elem.scrollTop() == elem.outerHeight());
				if (date == 0) date = new Date().getTime() / 1000;
				sender = sender == "*" ? "" : sender + ": ";
				$("#messages").append('<div class="messageC"><div class="message"><div class="sender">' + formatTime(date) + ' - ' + sender + '</div>' + linkify(message) + '</div></div>');
				if (atBottom)
					$("#messages").scrollTop($("#messages")[0].scrollHeight);
			}
			
			function formatTime(date) {
				date = new Date(date * 1000);
				var suffix = "";
				var hour = date.getHours();
				
				if (hour < 12)
					suffix = "AM";
				else
					suffix = "PM";
				
				if (hour == 0)
					hour = 12;
				if (hour > 12)
					hour = hour - 12;
					
				var min = date.getMinutes();
				if (min.toString().length == 1)
					min = "0" + min;
					
				return hour + ":" + min + " " + suffix;
			}
			
			// http://stackoverflow.com/a/7123542/1056845
			function linkify(str) {
				var urlPattern = /\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;
				var pseudoUrlPattern = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
				
				return str
					.replace(urlPattern, '<a href="$&" target="_blank">$&</a>')
					.replace(pseudoUrlPattern, '$1<a href="http://$2" target="_blank">$2</a>')
					.replace(/\n/g, '<br/>'); // line breaks, why not
			}
			
			$(document).ready(function () {
				connect();
				
				$("#chatSubmit").click(function () {
					var msg = $("#chatInput").val();
					if (msg.length == 0) return;
					if (msg.substring(0, 1) == "/") {
						if (msg.substring(0, 6) == "/clear") {
							$("#messages").html("");
						} else if (msg.substring(0, 5) == "/ban ") {
							var t = msg.substring(5);
							send({ Type: "ban", Target: t});
						} else if (msg.substring(0, 5) == "/list") {
							chat(msg); // serverside command
						} else if (msg.substring(0, 4) == "/me ") {
							chat(msg); // serverside command
						} else if (msg.substring(0, 7) == "/status") {
							chat(msg); // serverside command
						} else {
							addMessage(0, "*", "Unknown command.");
						}
						
						$("#chatInput").val("");
						return;
					}
					
					chat(msg);
					$("#chatInput").val("");
				});
				
				// http://stackoverflow.com/a/3533099/1056845
				$("#chatInput").keydown(function (e) {
					if (e.keyCode == 13) {
						if (e.ctrlKey) {
							var val = this.value;
							if (typeof this.selectionStart == "number" && typeof this.selectionEnd == "number") {
								var start = this.selectionStart;
								this.value = val.slice(0, start) + "\n" + val.slice(this.selectionEnd);
								this.selectionStart = this.selectionEnd = start + 1;
							} else if (document.selection && document.selection.createRange) {
								this.focus();
								var range = document.selection.createRange();
								range.text = "\r\n";
								range.collapse(false);
								range.select();
							}
						} else {
							$("#chatSubmit").click();
						}
						return false;
					}
				});
				
				$("#loginToggle").click(function () {
					$("#loginUsername").val("");
					$("#loginPassword").val("");
					$("#login").toggle();
				});
				
				$("#loginCancel").click(function () {
					$("#loginUsername").val("");
					$("#loginPassword").val("");
					$("#login").toggle();
				});
				
				$("#loginForm").submit(function () {
					var user = $("#loginUsername").val();
					var pass = $("#loginPassword").val();
					
					if (storage) {
						storage.setItem("user", user);
						storage.setItem("pass", hex_md5(pass));
					}
					
					login(user, pass, true);
					$("#loginUsername").val("");
					$("#loginPassword").val("");
					$("#login").toggle();
					return false;
				});
				
				$(window).resize(function () {
					var w = $(window).width();
					var h = $(window).height();
					var m = $("#messages");
					m.height(h - 90); // header + footer height
					m.width(w - 3); // container padding-left
					
					// scroll to bottom
					$("#messages").scrollTop($("#messages")[0].scrollHeight);
				});
				
				$(window).resize();
			});
		</script>
	</head>
	<body>
		<!-- before u whine about how shit this is u fix it -->
		<table>
			<tr class="header dark">
				<td>
					<div class="padTop">
						<a class="title">FP Programmers</a>
					</div>
				</td>
				<td style="width:65px">
					<div style="padding-right:4px">
						<a id="loginToggle" class="button">Login</a>
					</div>
				</td>
			</tr>
			<tr>
				<td colspan="2">
					<div id="messages" class="container">
						
					</div>
				</td>
			</tr>
			<tr class="footer dark">
				<td>
					<div class="padBottom">
						<textarea id="chatInput" class="chatInput" spellcheck="false"></textarea>
					</div>
				</td>
				<td style="width:65px">
					<div style="padding-right:4px">
						<a id="chatSubmit" class="button">Send</a>
					</div>
				</td>
			</tr>
		</table>
		
		<div id="login" class="loginContainer" style="display:none">
			<form id="loginForm" class="loginContent" action="">
				<h2>Login</h2>
				<table>
					<tr>
						<td>
							<label for="user">Username: </label>
						</td>
						<td style="padding-right:7px">
							<input id="loginUsername" name="user" type="text"/>
						</td>
					</tr>
					<tr>
						<td>
							<label for="pass">Password: </label>
						</td>
						<td style="padding-right:7px">
							<input id="loginPassword" name="pass" type="password"/>
						</td>
					</tr>
					<tr>
						<td>
							<a id="loginCancel" class="button" style="float:left;margin:3px">Cancel</a>
						</td>
						<td>
							<input class="button" style="margin:3px" type="submit" value="Login"/>
						</td>
					</tr>
				</table>
			</form>
		</div>
	</body>
</html>