<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>FP Programmers</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<script src="jquery-1.9.1.min.js"></script>
		<script src="md5-min.js"></script>
		<link rel="stylesheet" type="text/css" href="main.css"/>
		
		<script>
			var socket = null;
			
			setInterval(function () {
				if (socket != null)
					send({ Type: "ping" });
			}, 100);
			
			function connect() {
				socket = new WebSocket("ws://209.141.59.194:12000/");
				
				socket.onopen = function (event) {
					addMessage("*", "Connected to RohPod.");
					login("guest", "");
				};
				
				socket.onclose = function (event) {
					addMessage("*", "Lost connection to RohPod. Retrying...");
					socket = null;
					
					setTimeout(function () {
						connect();
					}, 1000);
				};
				
				socket.onerror = function (event) {
					addMessage("*", "WebSocket error: " + event.data + ". Reconnecting...");
					socket = null;
					
					setTimeout(function () {
						connect();
					}, 1000);
				};
				
				socket.onmessage = function (event) {
					var data = JSON.parse(event.data);
					
					switch (data.Type)
					{
						case "chatLock": {
							if (data.CanChat) {
								$("#chatInput").removeAttr('disabled');
								$("#chatInput").val("");
							} else {
								$("#chatInput").attr("disabled","disabled");
								$("#chatInput").val("Guests can not speak.");
							}
							break;
						}
						
						case "openChat": {
							for (var i = 0; i < data.History.length; i++) {
								var f = data.History[i];
								addMessage(f.Item1, f.Item2);
							}
							
							// make sure we scroll to the bottom
							$('#messages').scrollTop($('#messages')[0].scrollHeight);
							setTimeout(function () {
								$('#messages').scrollTop($('#messages')[0].scrollHeight);
							}, 250);
							break;
						}
						
						case "message": {
							addMessage(data.Sender, data.Message);
							break;
						}
					}
				};
			}
			
			function send(obj) {
				socket.send(JSON.stringify(obj));
			}
			
			function login(username, password) {
				send({ Type: "login", Username: username, Password: hex_md5(password) });
			}
			
			function chat(message) {
				send({ Type: "message", Message: message });
			}
			
			function addMessage(sender, message) {
				var elem = $('#messages');
				var atBottom = (elem[0].scrollHeight - elem.scrollTop() == elem.outerHeight());
				$('#messages').append('<div class="messageC"><div class="message"><div class="sender">' + sender + ': </div>' + linkify(message) + '</div></div>');
				if (atBottom)
					$('#messages').scrollTop($('#messages')[0].scrollHeight);
			}
			
			// http://stackoverflow.com/a/7123542/1056845
			function linkify(str) {
				var urlPattern = /\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;
				var pseudoUrlPattern = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
				
				return str
					.replace(urlPattern, '<a href="$&">$&</a>')
					.replace(pseudoUrlPattern, '$1<a href="http://$2">$2</a>')
					.replace(/\n/g, '<br/>'); // line breaks, why not
			}
			
			$(document).ready(function () {
				connect();
				
				$("#chatSubmit").click(function () {
					var msg = $("#chatInput").val();
					if (msg.length == 0) return;
					if (msg.substring(0, 6) == "/pass ") {
						var p = msg.substring(6);
						addMessage("*", "Hash is: " + hex_md5(p));
						$("#chatInput").val("");
						return;
					}
					if (msg.substring(0, 5) == "/ban ") {
						var t = msg.substring(5);
						send({ Type: "ban", Target: t});
						$("#chatInput").val("");
						return;
					}
					chat(msg);
					$("#chatInput").val("");
				});
				
				// http://stackoverflow.com/a/3533099/1056845
				$("#chatInput").keydown(function (e) {
					if (e.keyCode == 13) {
						if (e.ctrlKey) {
							var val = this.value;
							if (typeof this.selectionStart == "number" && typeof this.selectionEnd == "number") {
								var start = this.selectionStart;
								this.value = val.slice(0, start) + "\n" + val.slice(this.selectionEnd);
								this.selectionStart = this.selectionEnd = start + 1;
							} else if (document.selection && document.selection.createRange) {
								this.focus();
								var range = document.selection.createRange();
								range.text = "\r\n";
								range.collapse(false);
								range.select();
							}
						} else {
							$("#chatSubmit").click();
						}
						return false;
					}
				});
				
				$("#loginToggle").click(function () {
					$("#login").toggle();
				});
				
				$("#loginCancel").click(function () {
					$("#loginUsername").val("");
					$("#loginPassword").val("");
					$("#login").toggle();
				});
				
				$("#loginForm").submit(function () {
					var user = $("#loginUsername").val();
					var pass = $("#loginPassword").val();
					login(user, pass);
					$("#loginUsername").val("");
					$("#loginPassword").val("");
					$("#login").toggle();
					return false;
				});
				
				$(window).resize(function () {
					var w = $(window).width();
					var h = $(window).height();
					var m = $("#messages");
					m.height(h - 90); // header + footer height
					m.width(w - 3); // container padding-left
					
					// scroll to bottom
					$('#messages').scrollTop($('#messages')[0].scrollHeight);
				});
				
				$(window).resize();
			});
		</script>
	</head>
	<body>
		<!-- before u whine about how shit this is u fix it -->
		<table>
			<tr class="header dark">
				<td>
					<div class="padTop">
						<a class="title">FP Programmers</a>
					</div>
				</td>
				<td style="width:65px">
					<div style="padding-right:4px">
						<a id="loginToggle" class="button">Login</a>
					</div>
				</td>
			</tr>
			<tr>
				<td colspan="2">
					<div id="messages" class="container">
						
					</div>
				</td>
			</tr>
			<tr class="footer dark">
				<td>
					<div class="padBottom">
						<textarea id="chatInput" class="chatInput" spellcheck="false"></textarea>
					</div>
				</td>
				<td style="width:65px">
					<div style="padding-right:4px">
						<a id="chatSubmit" class="button">Send</a>
					</div>
				</td>
			</tr>
		</table>
		
		<div id="login" class="loginContainer" style="display:none">
			<form id="loginForm" class="loginContent" action="">
				<h2>Login</h2>
				<table>
					<tr>
						<td>
							<label for="user">Username: </label>
						</td>
						<td style="padding-right:7px">
							<input id="loginUsername" name="user" type="text"/>
						</td>
					</tr>
					<tr>
						<td>
							<label for="pass">Password: </label>
						</td>
						<td style="padding-right:7px">
							<input id="loginPassword" name="pass" type="password"/>
						</td>
					</tr>
					<tr>
						<td>
							<a id="loginCancel" class="button" style="float:left;margin:3px">Cancel</a>
						</td>
						<td>
							<input class="button" style="margin:3px" type="submit" value="Login"/>
						</td>
					</tr>
				</table>
			</form>
		</div>
	</body>
</html>